<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Time-walk Correction: Apply &#8212; luna 0.2.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=6b2e5161" />
    <script src="../_static/documentation_options.js?v=58050c01"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/copytoclipboard.js?v=38cfd8db"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Time-walk Correction: Matrix" href="ex8_timewalk_matrix.html" />
    <link rel="prev" title="Plotting Distributions" href="ex6_plot_distributions.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=orange data-md-color-accent=amber>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#3_examples/ex7_correct_toa_for_timewalk" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="luna 0.2.7 documentation"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">luna-logo.png</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Luna Documentation</span>
          <span class="md-header-nav__topic"> Time-walk Correction: Apply </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">luna 0.2.7 documentation</a></li>
          <li class="md-tabs__item"><a href="examples.html" class="md-tabs__link">Examples</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="luna 0.2.7 documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">luna-logo.png</i>
      
    </a>
    <a href="../index.html"
       title="luna 0.2.7 documentation">Luna Documentation</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../index.html" class="md-nav__link">Luna</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../1_usage/usage.html" class="md-nav__link">Usage</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../1_usage/cli_configuration.html" class="md-nav__link">Command Line Interface</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../1_usage/yaml_configuration.html" class="md-nav__link">Yaml Interface</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../2_concepts/concepts.html" class="md-nav__link">Concepts</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../2_concepts/time_units.html" class="md-nav__link">Time Units in Luna</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../2_concepts/time_binning.html" class="md-nav__link">Time Binning</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="examples.html" class="md-nav__link">Examples</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="ex1_read_data.html" class="md-nav__link">Read Data</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex2_read_data_time_units.html" class="md-nav__link">Read data, Unit Conversion</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex3_plot_pixel_2d_histogram.html" class="md-nav__link">Plot Pixel Data: 2D Histogram</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex4_plot_pixel_2d_histogram_time_slice.html" class="md-nav__link">Plot Pixel Data: 2D Histogram Time Slice</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex5_plot_cluster_2d_histogram.html" class="md-nav__link">Plot Pixel Data: Time Slice</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex6_plot_distributions.html" class="md-nav__link">Plotting Distributions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> Time-walk Correction: Apply </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">Time-walk Correction: Apply</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#3-examples-ex7-correct-toa-for-timewalk--page-root" class="md-nav__link">Time-walk Correction: Apply</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#luna-command" class="md-nav__link">Luna Command</a>
        </li>
        <li class="md-nav__item"><a href="#python-script" class="md-nav__link">Python Script</a>
        </li>
        <li class="md-nav__item"><a href="#script-output" class="md-nav__link">Script Output</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/3_examples/ex7_correct_toa_for_timewalk.rst.txt">Show Source</a> </li>

  </ul>
</nav>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex8_timewalk_matrix.html" class="md-nav__link">Time-walk Correction: Matrix</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex9_constructing_lookup_tables.html" class="md-nav__link">Time-walk Correction: Constructing LUT</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ex10_hdf5_compression_investigation.html" class="md-nav__link">Hdf5 Compression Investigation</a>
      
    
    </li></ul>
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#3-examples-ex7-correct-toa-for-timewalk--page-root" class="md-nav__link">Time-walk Correction: Apply</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#luna-command" class="md-nav__link">Luna Command</a>
        </li>
        <li class="md-nav__item"><a href="#python-script" class="md-nav__link">Python Script</a>
        </li>
        <li class="md-nav__item"><a href="#script-output" class="md-nav__link">Script Output</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/3_examples/ex7_correct_toa_for_timewalk.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="time-walk-correction-apply">
<h1 id="3-examples-ex7-correct-toa-for-timewalk--page-root">Time-walk Correction: Apply<a class="headerlink" href="#3-examples-ex7-correct-toa-for-timewalk--page-root" title="Link to this heading">¶</a></h1>
<p>Luna outputs timewalk correction matrix and lookup tables for correcting the ToA
based on the magnitude of the ToT and a relationship inferred from your data. That
relationship can be examined to refine your curve by adjusting the ctot-cut parameter.</p>
<p>However once you are happy with your lookup table application of the correction is a
simple matter of lookup and subtraction.</p>
<section id="luna-command">
<h2 id="luna-command">Luna Command<a class="headerlink" href="#luna-command" title="Link to this heading">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tpx3dump<span class="w"> </span>process<span class="w"> </span>-i<span class="w"> </span>/Users/Ciaran/atlassian-bitbucket-pipelines-runner/temp/e71169e4-520a-5b30-a5ab-ee8a44eb5fac/build/docs/source/_static/example_data.tpx3<span class="w"> </span>-o<span class="w"> </span>/Users/Ciaran/atlassian-bitbucket-pipelines-runner/temp/e71169e4-520a-5b30-a5ab-ee8a44eb5fac/build/docs/source/_static/example_data.hdf5<span class="w">  </span>--eps-t<span class="w"> </span>150ns<span class="w"> </span>--eps-s<span class="w"> </span><span class="m">1</span><span class="w"> </span>--ctot-cut<span class="w"> </span><span class="m">500</span>
</pre></div>
</div>
</section>
<section id="python-script">
<h2 id="python-script">Python Script<a class="headerlink" href="#python-script" title="Link to this heading">¶</a></h2>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Apply the timewalk correction</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 3</span><span class="kn">import</span> <span class="nn">lmfit</span>
<span class="linenos"> 4</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  <span class="c1"># ensure you have `pip install pandas`</span>
<span class="linenos"> 5</span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="linenos"> 6</span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="linenos"> 7</span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="linenos"> 8</span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="linenos"> 9</span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>  <span class="c1"># suppress warnings from plotting libraries.</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s2">"talk"</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c1"># add some paths to PYTHONPATH</span>
<span class="linenos">16</span><span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">]:</span>
<span class="linenos">17</span>    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">directory</span><span class="p">)))</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="c1"># on our system "EXAMPLE_DATA_HDF5" refers to the absolute path</span>
<span class="linenos">20</span><span class="c1"># to a hdf5 file generated by luna. Replace with your own!</span>
<span class="linenos">21</span><span class="kn">from</span> <span class="nn">env_vars_for_docs_examples</span> <span class="kn">import</span> <span class="n">EXAMPLE_DATA_HDF5</span><span class="p">,</span> <span class="n">PLOTS_DIRECTORY</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="c1"># re-use functions from previous example</span>
<span class="linenos">24</span><span class="kn">from</span> <span class="nn">ex2_read_data_time_units</span> <span class="kn">import</span> <span class="n">load_pixel_hits</span><span class="p">,</span> <span class="n">load_timewalk_lookup_table</span><span class="p">,</span> <span class="n">TimeUnit</span>
<span class="linenos">25</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="k">def</span> <span class="nf">apply_timewalk_correction</span><span class="p">(</span><span class="n">pixel_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">timewalk_lut</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="linenos">28</span><span class="w">    </span><span class="sd">"""Takes the timewalk look up table (LUT) that was calculated by luna (using some</span>
<span class="linenos">29</span><span class="sd">    ctot-cut parameter x) and uses it to correct ToA for timewalk effects</span>
<span class="linenos">30</span><span class="sd">    """</span>
<span class="linenos">31</span>    <span class="n">pixel_data</span><span class="p">[</span><span class="s2">"corrected_toa"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_data</span><span class="p">[</span><span class="s2">"toa"</span><span class="p">]</span> <span class="o">-</span> <span class="n">pixel_data</span><span class="p">[</span><span class="s2">"tot"</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">timewalk_lut</span><span class="p">[</span><span class="s2">"AverageDToA"</span><span class="p">])</span>
<span class="linenos">32</span>    <span class="k">return</span> <span class="n">pixel_data</span>
<span class="linenos">33</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="k">def</span> <span class="nf">plot_lookup_table</span><span class="p">(</span><span class="n">timewalk_lut</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">toa_unit</span><span class="p">:</span> <span class="n">TimeUnit</span><span class="p">):</span>
<span class="linenos">36</span><span class="w">    </span><span class="sd">"""Plot a scatter graph with error bars (Std) of the timewakl lookup table"""</span>
<span class="linenos">37</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="linenos">38</span>    <span class="nb">print</span><span class="p">(</span><span class="n">timewalk_lut</span><span class="p">)</span>
<span class="linenos">39</span>    <span class="n">timewalk_lut</span> <span class="o">=</span> <span class="n">timewalk_lut</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"AverageDToA"</span><span class="p">,</span> <span class="s2">"Std"</span><span class="p">])</span>
<span class="linenos">40</span>    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">timewalk_lut</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">timewalk_lut</span><span class="p">[</span><span class="s2">"AverageDToA"</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">timewalk_lut</span><span class="p">[</span><span class="s2">"Std"</span><span class="p">],</span>
<span class="linenos">41</span>                 <span class="n">marker</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"None"</span> <span class="p">)</span>
<span class="linenos">42</span>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"ToT (ns)"</span><span class="p">)</span>
<span class="linenos">43</span>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mean dToA </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">toa_unit</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2"> (Err=STD))"</span><span class="p">)</span>
<span class="linenos">44</span>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Effect of ToT magnitude on ToA"</span><span class="p">)</span>
<span class="linenos">45</span>
<span class="linenos">46</span>    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="linenos">47</span>
<span class="linenos">48</span>    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PLOTS_DIRECTORY</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"ex7_correct_toa_for_timewalk.png"</span><span class="p">)</span>
<span class="linenos">49</span>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">"tight"</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="linenos">50</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<span class="linenos">53</span>    <span class="n">toa_unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="n">Nanoseconds</span>
<span class="linenos">54</span>    <span class="n">pixel_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">load_pixel_hits</span><span class="p">(</span><span class="n">EXAMPLE_DATA_HDF5</span><span class="p">,</span> <span class="n">toa_unit</span><span class="p">)</span>
<span class="linenos">55</span>    <span class="n">timewalk_lut</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_timewalk_lookup_table</span><span class="p">(</span><span class="n">EXAMPLE_DATA_HDF5</span><span class="p">,</span> <span class="n">toa_unit</span><span class="p">)</span>
<span class="linenos">56</span>
<span class="linenos">57</span>    <span class="k">if</span> <span class="n">timewalk_lut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">58</span>        <span class="n">pixel_data</span> <span class="o">=</span> <span class="n">apply_timewalk_correction</span><span class="p">(</span><span class="n">pixel_data</span><span class="o">=</span><span class="n">pixel_data</span><span class="p">,</span> <span class="n">timewalk_lut</span><span class="o">=</span><span class="n">timewalk_lut</span><span class="p">)</span>
<span class="linenos">59</span>
<span class="linenos">60</span>        <span class="n">plot_lookup_table</span><span class="p">(</span><span class="n">timewalk_lut</span><span class="o">=</span><span class="n">timewalk_lut</span><span class="p">,</span> <span class="n">toa_unit</span><span class="o">=</span><span class="n">toa_unit</span><span class="p">)</span>
<span class="linenos">61</span>
<span class="linenos">62</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">"Timewalk corrected ToA's"</span><span class="p">)</span>
<span class="linenos">63</span>        <span class="nb">print</span><span class="p">(</span><span class="n">pixel_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
</section>
<section id="script-output">
<h2 id="script-output">Script Output<a class="headerlink" href="#script-output" title="Link to this heading">¶</a></h2>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Example Output</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hdf5</span> <span class="n">datasets</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Clusters'</span><span class="p">,</span> <span class="s1">'ExposureTimeBoundaries'</span><span class="p">,</span> <span class="s1">'PixelHits'</span><span class="p">,</span> <span class="s1">'TimewalkLookupTable'</span><span class="p">,</span> <span class="s1">'TimewalkMatrix'</span><span class="p">]</span>
      <span class="n">AverageDToA</span>  <span class="n">SumSquareDiff</span>        <span class="n">Std</span>  <span class="n">Count</span>
<span class="n">ToT</span>                                               
<span class="mi">25</span>      <span class="mf">76.245934</span>    <span class="mf">803962240.0</span>  <span class="mf">23.546906</span>    <span class="mi">146</span>
<span class="mi">50</span>      <span class="mf">70.257935</span>    <span class="mf">642109440.0</span>  <span class="mf">20.419456</span>    <span class="mi">155</span>
<span class="mi">75</span>      <span class="mf">60.629959</span>    <span class="mf">549626880.0</span>  <span class="mf">18.476557</span>    <span class="mi">162</span>
<span class="mi">100</span>     <span class="mf">50.204540</span>    <span class="mf">444413952.0</span>  <span class="mf">16.562899</span>    <span class="mi">163</span>
<span class="mi">125</span>     <span class="mf">43.402039</span>    <span class="mf">267351552.0</span>  <span class="mf">12.729150</span>    <span class="mi">166</span>
<span class="o">...</span>           <span class="o">...</span>            <span class="o">...</span>        <span class="o">...</span>    <span class="o">...</span>
<span class="mi">6200</span>     <span class="mf">0.000000</span>            <span class="mf">0.0</span>   <span class="mf">0.000000</span>      <span class="mi">1</span>
<span class="mi">6400</span>    <span class="o">-</span><span class="mf">1.562500</span>            <span class="mf">0.0</span>   <span class="mf">0.000000</span>      <span class="mi">1</span>
<span class="mi">6675</span>     <span class="mf">0.000000</span>            <span class="mf">0.0</span>   <span class="mf">0.000000</span>      <span class="mi">1</span>
<span class="mi">6825</span>     <span class="mf">0.000000</span>            <span class="mf">0.0</span>   <span class="mf">0.000000</span>      <span class="mi">1</span>
<span class="mi">6850</span>     <span class="mf">0.000000</span>            <span class="mf">0.0</span>   <span class="mf">0.000000</span>      <span class="mi">1</span>

<span class="p">[</span><span class="mi">212</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">]</span>
<span class="n">Timewalk</span> <span class="n">corrected</span> <span class="n">ToA</span><span class="s1">'s</span>
             <span class="n">toa</span>  <span class="n">corrected_toa</span>  <span class="n">cid</span>    <span class="n">dtoa</span>   <span class="n">tot</span>    <span class="n">x</span>    <span class="n">y</span>
<span class="mi">0</span>   <span class="mf">1.103455e+10</span>   <span class="mf">1.103455e+10</span>    <span class="mi">0</span>       <span class="mi">0</span>   <span class="mi">200</span>  <span class="mi">140</span>  <span class="mi">193</span>
<span class="mi">1</span>   <span class="mf">1.103455e+10</span>   <span class="mf">1.103455e+10</span>    <span class="mi">1</span>       <span class="mi">0</span>   <span class="mi">150</span>  <span class="mi">143</span>  <span class="mi">193</span>
<span class="mi">2</span>   <span class="mf">1.103459e+10</span>   <span class="mf">1.103459e+10</span>    <span class="mi">2</span>       <span class="mi">0</span>  <span class="mi">1475</span>   <span class="mi">68</span>   <span class="mi">92</span>
<span class="mi">3</span>   <span class="mf">1.103459e+10</span>   <span class="mf">1.103459e+10</span>    <span class="mi">2</span>   <span class="mi">15625</span>   <span class="mi">850</span>   <span class="mi">67</span>   <span class="mi">92</span>
<span class="mi">4</span>   <span class="mf">1.103459e+10</span>   <span class="mf">1.103459e+10</span>    <span class="mi">2</span>  <span class="mi">218750</span>   <span class="mi">300</span>   <span class="mi">68</span>   <span class="mi">91</span>
<span class="mi">5</span>   <span class="mf">1.103459e+10</span>   <span class="mf">1.103459e+10</span>    <span class="mi">2</span>  <span class="mi">453125</span>   <span class="mi">150</span>   <span class="mi">67</span>   <span class="mi">91</span>
<span class="mi">6</span>   <span class="mf">1.103464e+10</span>   <span class="mf">1.103464e+10</span>    <span class="mi">3</span>       <span class="mi">0</span>   <span class="mi">800</span>   <span class="mi">80</span>   <span class="mi">80</span>
<span class="mi">7</span>   <span class="mf">1.103464e+10</span>   <span class="mf">1.103464e+10</span>    <span class="mi">3</span>  <span class="mi">218750</span>   <span class="mi">250</span>   <span class="mi">80</span>   <span class="mi">81</span>
<span class="mi">8</span>   <span class="mf">1.103464e+10</span>   <span class="mf">1.103464e+10</span>    <span class="mi">3</span>  <span class="mi">296875</span>   <span class="mi">250</span>   <span class="mi">79</span>   <span class="mi">80</span>
<span class="mi">9</span>   <span class="mf">1.103470e+10</span>   <span class="mf">1.103470e+10</span>    <span class="mi">4</span>       <span class="mi">0</span>   <span class="mi">375</span>   <span class="mi">14</span>   <span class="mi">18</span>
<span class="mi">10</span>  <span class="mf">1.103470e+10</span>   <span class="mf">1.103470e+10</span>    <span class="mi">4</span>   <span class="mi">31250</span>   <span class="mi">375</span>   <span class="mi">14</span>   <span class="mi">19</span>
<span class="mi">11</span>  <span class="mf">1.103493e+10</span>   <span class="mf">1.103493e+10</span>    <span class="mi">5</span>       <span class="mi">0</span>   <span class="mi">375</span>   <span class="mi">49</span>    <span class="mi">5</span>
<span class="mi">12</span>  <span class="mf">1.103506e+10</span>   <span class="mf">1.103506e+10</span>    <span class="mi">6</span>       <span class="mi">0</span>  <span class="mi">1675</span>  <span class="mi">146</span>  <span class="mi">106</span>
<span class="mi">13</span>  <span class="mf">1.103506e+10</span>   <span class="mf">1.103506e+10</span>    <span class="mi">6</span>   <span class="mi">78125</span>   <span class="mi">425</span>  <span class="mi">146</span>  <span class="mi">105</span>
<span class="mi">14</span>  <span class="mf">1.103506e+10</span>   <span class="mf">1.103506e+10</span>    <span class="mi">6</span>  <span class="mi">171875</span>   <span class="mi">350</span>  <span class="mi">145</span>  <span class="mi">106</span>
</pre></div>
</div>
</div>
<figure class="align-right">
<a class="reference internal image-reference" href="../_images/ex7_correct_toa_for_timewalk.png"><img alt="../_images/ex7_correct_toa_for_timewalk.png" src="../_images/ex7_correct_toa_for_timewalk.png" style="width: 80%;"/></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since we are (necessarily) using a small tpx3 file for the examples there is some
instability between the ToT=2000ns - 4000ns. This is because the time walk lookup
table is inferred directly from your data and since this dataset is minimal there
may not be enough data to fully inform the timewalk matrix.</p>
</div>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="ex6_plot_distributions.html" title="Plotting Distributions"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> Plotting Distributions </span>
              </div>
            </a>
          
          
            <a href="ex8_timewalk_matrix.html" title="Time-walk Correction: Matrix"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> Time-walk Correction: Matrix </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, Ciaran Welsh.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>